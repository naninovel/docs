{
    "name": "naniscript",
    "scopeName": "source.naniscript",
    "fileTypes": ["nani"],
    "patterns": [
        { "include": "#comment-line" },
        { "include": "#label-line" },
        { "include": "#command-line" },
        { "include": "#generic-text-line" }
    ],
    "repository": {
        "comment-line": {
            "match": "^\\s*;.*$",
            "name": "naniscript.comment"
        },
        "label-line": {
            "begin": "^\\s*(?=#)",
            "end": "$",
            "name": "naniscript.label",
            "patterns": [
                { "match": ";.*$", "name": "naniscript.comment" }
            ]
        },
        "command-line": {
            "begin": "^\\s*(?=@)",
            "end": "$",
            "name": "naniscript.command.parameter.value",
            "patterns": [
                { "include": "#command-comment" },
                { "include": "#expression-command-identifier" },
                { "include": "#navigation-command-identifier" },
                { "include": "#command-identifier" },
                { "include": "#command-parameters" }
            ]
        },
        "expression-command-identifier": {
            "match": "\\G(@(?:if|unless|or|while|set))(?:\\s((?:\\{[^}]*\\}|\"(?:[^\"\\\\]|\\\\.)*\"|\\\\.|[^\\s]|\\s(?![A-Za-z_][A-Za-z0-9_]*[!:]|![A-Za-z_]|;))+))?",
            "captures": {
                "1": { "name": "naniscript.command" },
                "2": { "name": "naniscript.expression" }
            }
        },
        "navigation-command-identifier": {
            "match": "\\G(@(?:goto|gosub))(?:\\s((?:\\{[^}]*\\}|\"(?:[^\"\\\\]|\\\\.)*\"|\\\\.|[^\\s\\]])+))?",
            "captures": {
                "1": { "name": "naniscript.command" },
                "2": { "name": "naniscript.label" }
            }
        },
        "command-identifier": {
            "match": "\\G@\\S+",
            "name": "naniscript.command"
        },
        "command-comment": {
            "match": "\\s;.*$",
            "name": "naniscript.comment"
        },
        "command-parameters": {
            "patterns": [
                { "include": "#command-comment" },
                { "include": "#expression-parameter" },
                { "include": "#navigation-parameter" },
                { "include": "#named-parameter" },
                { "include": "#boolean-parameter" },
                { "include": "#quoted-value" },
                { "include": "#quoted-value-with-expressions" },
                { "include": "#expression" },
                { "include": "#text-identifier" }
            ]
        },
        "expression-parameter": {
            "begin": "(\\s(?:if|unless|or|set):)\\s*",
            "beginCaptures": { "1": { "name": "naniscript.command.parameter.id" } },
            "end": "(?=\\s[A-Za-z_][A-Za-z0-9_]*[!:]|\\s![A-Za-z_]|\\s;|\\s*$|\\s*\\])",
            "contentName": "naniscript.command.parameter.id",
            "patterns": [
                { "match": "(?:\\{[^}]*\\}|\"(?:[^\"\\\\]|\\\\.)*\"|\\\\.|[^\\s\\]]|\\s(?![A-Za-z_][A-Za-z0-9_]*[!:]|![A-Za-z_]|;|\\]))+", "name": "naniscript.expression" }
            ]
        },
        "navigation-parameter": {
            "begin": "(\\s(?:goto|gosub):)",
            "beginCaptures": { "1": { "name": "naniscript.command.parameter.id" } },
            "end": "(?=\\s|$|\\])",
            "contentName": "naniscript.command.parameter.id",
            "patterns": [
                { "match": "(?:\\{[^}]*\\}|\"(?:[^\"\\\\]|\\\\.)*\"|\\\\.|[^\\s\\]])+", "name": "naniscript.label" }
            ]
        },
        "named-parameter": {
            "match": "\\s[A-Za-z_][A-Za-z0-9_]*:",
            "name": "naniscript.command.parameter.id"
        },
        "boolean-parameter": {
            "begin": "(\\s(?:[A-Za-z_][A-Za-z0-9_]*(?=!)|(?=!)))",
            "beginCaptures": { "1": { "name": "naniscript.command.parameter.id" } },
            "end": "(?=\\s|$|;|\\])",
            "contentName": "naniscript.command.parameter.id",
            "patterns": [
                { "match": "!", "name": "naniscript.command.parameter.value" }
            ]
        },
        "expression": {
            "match": "(?<!\\\\)\\{[^}]*\\}",
            "name": "naniscript.expression"
        },
        "text-identifier": {
            "match": "\\|#[^|]*\\|",
            "name": "naniscript.text-identifier"
        },
        "quoted-value": {
            "match": "(?<!\\\\)\"[^\"|]*(?<!\\\\)\"",
            "name": "naniscript.generic-text"
        },
        "quoted-value-with-expressions": {
            "begin": "(?<!\\\\)\"",
            "end": "(?<!\\\\)\"",
            "name": "naniscript.generic-text",
            "patterns": [
                { "include": "#text-identifier" },
                { "include": "#expression" }
            ]
        },
        "generic-text-line": {
            "begin": "^(?!\\s*[@#;])\\s*",
            "end": "$",
            "name": "naniscript.generic-text",
            "patterns": [
                { "include": "#author-prefix" },
                { "include": "#generic-text-content" }
            ]
        },
        "author-prefix": {
            "begin": "\\G([A-Za-z_][A-Za-z0-9_.]*:)",
            "beginCaptures": { "1": { "name": "naniscript.author" } },
            "end": "(?=$)",
            "patterns": [
                { "include": "#author-space" }
            ]
        },
        "author-space": {
            "begin": "\\G\\s",
            "end": "(?=$)",
            "patterns": [
                { "include": "#generic-text-content" }
            ]
        },
        "generic-text-content": {
            "patterns": [
                { "include": "#inline-command" },
                { "include": "#expression" },
                { "include": "#text-identifier" },
                { "include": "#tag-close" },
                { "include": "#tag-select" },
                { "include": "#tag-special" },
                { "include": "#tag" }
            ]
        },
        "inline-command": {
            "begin": "(?=(?<!\\\\)\\[)",
            "end": "(\\])|$",
            "endCaptures": { "1": { "name": "naniscript.command.inline" } },
            "name": "naniscript.command.parameter.value",
            "patterns": [
                { "include": "#expression-inline-command-identifier" },
                { "include": "#inline-command-identifier" },
                { "include": "#inline-command-bracket" },
                { "include": "#inline-command-comment" },
                { "include": "#inline-command-parameters" }
            ]
        },
        "expression-inline-command-identifier": {
            "match": "\\G(\\[)((?:if|unless|or)(?=\\s|\\]))(?:\\s((?:\\{[^}]*\\}|\"(?:[^\"\\\\]|\\\\.)*\"|\\\\.|[^\\s\\]]|\\s(?![A-Za-z_][A-Za-z0-9_]*[!:]|![A-Za-z_]|;|\\]))+))?",
            "captures": {
                "1": { "name": "naniscript.command.inline" },
                "2": { "name": "naniscript.command" },
                "3": { "name": "naniscript.expression" }
            }
        },
        "inline-command-identifier": {
            "match": "\\G\\[(?:[A-Za-z_][A-Za-z0-9_]*|[\\-><])",
            "name": "naniscript.command.inline"
        },
        "inline-command-bracket": {
            "match": "\\G\\[",
            "name": "naniscript.command.inline"
        },
        "inline-command-comment": {
            "match": "\\s?;[^\\]]*",
            "name": "naniscript.comment"
        },
        "inline-command-parameters": {
            "patterns": [
                { "include": "#inline-command-comment" },
                { "include": "#expression-parameter" },
                { "include": "#navigation-parameter" },
                { "include": "#named-parameter" },
                { "include": "#boolean-parameter" },
                { "include": "#quoted-value" },
                { "include": "#quoted-value-with-expressions" },
                { "include": "#expression" },
                { "include": "#text-identifier" }
            ]
        },
        "tag-close": {
            "match": "</[A-Za-z][A-Za-z0-9]*>",
            "name": "naniscript.tag"
        },
        "tag-select": {
            "begin": "</",
            "end": ">",
            "name": "naniscript.tag",
            "patterns": [
                { "match": "[^/>]+", "name": "naniscript.select-option" }
            ]
        },
        "tag-special": {
            "match": "<[@:][^>]*>",
            "name": "naniscript.tag"
        },
        "tag": {
            "match": "<[A-Za-z][^>]*>|<->",
            "name": "naniscript.tag"
        }
    }
}
